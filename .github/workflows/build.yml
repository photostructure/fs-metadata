name: Build & Release

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: "fs-metadata release: bump version"
        required: false
        type: choice
        options:
          - patch
          - minor
          - major
        default: "minor"
run-name: ${{ github.event_name == 'workflow_dispatch' && format('Release - {0}', github.event.inputs.version) || format('Build - {0}', github.event.head_commit.message || github.event.pull_request.title) }}
jobs:

  lint:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update
      - run: sudo apt-get install -y clang-tidy bear build-essential libglib2.0-dev libblkid-dev uuid-dev
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      - run: npm ci --ignore-scripts
      - run: npm run lint

  prebuild-mac-win:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      # We need to ignore scripts so the `install` script in package.json does
      # not run node-gyp-build
      - run: npm ci --ignore-scripts
      - run: npm run build:native
      - uses: actions/upload-artifact@v4
        with:
          name: prebuilds-${{ matrix.os }}
          path: prebuilds/

  prebuild-linux-glibc:
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
    runs-on: ubuntu-24.04 # Use newer runner for Docker support
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-qemu
        with:
          arch: ${{ matrix.arch }}
      # Build in Debian 11 Bullseye container for GLIBC 2.31 compatibility
      # This ensures compatibility with Ubuntu 20.04+ and modern Node.js Docker images
      # Note: npm ci is run inside the container by the build:linux-glibc script
      - run: TARGET_ARCH=${{ matrix.arch }} npm run build:linux-glibc
      - uses: actions/upload-artifact@v4
        with:
          name: prebuilds-linux-${{ matrix.arch }}-glibc
          path: prebuilds/

  prebuild-linux-musl:
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-qemu
        with:
          arch: ${{ matrix.arch }}
      - run: |
          docker run --rm -v $(pwd):/tmp/project --entrypoint /bin/sh --platform linux/${{ matrix.arch == 'x64' && 'amd64' || 'arm64' }} node:20-alpine3.21 -c "\
          apk add build-base git python3 py3-setuptools util-linux-dev --update-cache && \
          cd /tmp/project && \
          npm ci --ignore-scripts && \
          npm run build:native"
      - uses: actions/upload-artifact@v4
        with:
          name: prebuilds-linux-${{ matrix.arch }}-musl
          path: prebuilds/

  test-mac-win:
    needs: [prebuild-mac-win]
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, windows-latest]
        node-version: [20, 22, 23, 24]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: ./prebuilds
          merge-multiple: true
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
      - run: npm ci
      - run: npm run tests

  test-ubuntu:
    needs: [prebuild-linux-glibc]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        arch: [x64, arm64]
        node-version: [20, 22, 23, 24]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-qemu
        with:
          arch: ${{ matrix.arch }}
      - run: sudo apt-get update
      - run: sudo apt-get install -y libglib2.0-dev libblkid-dev uuid-dev
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - uses: actions/download-artifact@v4
        with:
          path: ./prebuilds
          merge-multiple: true
      - run: npm ci
      - run: npm run tests

  test-alpine:
    needs: [prebuild-linux-musl]
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
        node-version: [20, 22, 23, 24]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-qemu
        with:
          arch: ${{ matrix.arch }}
      - uses: actions/download-artifact@v4
        with:
          path: ./prebuilds
          merge-multiple: true
      - run: |
          docker run --rm -v $(pwd):/tmp/project --entrypoint /bin/sh --platform linux/${{ matrix.arch == 'x64' && 'amd64' || 'arm64' }} node:${{ matrix.node-version }}-alpine -c "\
          apk add util-linux-dev bash valgrind --update-cache && \
          cd /tmp/project && \
          npm ci && \
          npm run tests"


  publish:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-24.04
    needs: [test-mac-win, test-ubuntu, test-alpine, lint]
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: ./prebuilds
          merge-multiple: true
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "npm"
      - run: ls -laR ./prebuilds
      - run: npm ci
      - run: npm run prepare-release

      # readme: https://github.com/actions/checkout?tab=readme-ov-file#push-a-commit-using-the-built-in-token
      # https://chatgpt.com/share/6761e017-9950-800e-ba1e-94d575010f2d

      - name: Configure git for GitHub Actions bot
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Configure npm for publishing
        run: npm config set //registry.npmjs.org/:_authToken ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        run: npm run release -- --ci ${{ github.event.inputs.version }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove npm token
        if: always()
        run: npm config delete //registry.npmjs.org/:_authToken
