name: Build & Release

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: "fs-metadata release: bump version (current = use package.json)"
        required: false
        type: choice
        default: "current"
        options:
          - current
          - patch
          - minor
          - major
run-name: ${{ github.event_name == 'workflow_dispatch' && format('Release - {0}', github.event.inputs.version) || format('Build - {0}', github.event.head_commit.message || github.event.pull_request.title) }}
jobs:
  lint:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # Linux-specific dependencies
      - if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy bear build-essential libglib2.0-dev libblkid-dev uuid-dev

      # Windows clang-tidy installation
      - if: runner.os == 'Windows'
        run: |
          # Check if clang-tidy is available in common locations
          $found = $false
          $paths = @(
            "C:\Program Files\LLVM\bin\clang-tidy.exe",
            "C:\Program Files (x86)\LLVM\bin\clang-tidy.exe"
          )

          foreach ($path in $paths) {
            if (Test-Path $path) {
              Write-Host "Found clang-tidy at: $path"
              $found = $true
              break
            }
          }

          if (-not $found) {
            Write-Host "Installing LLVM/clang-tidy..."
            # Install via Chocolatey (available on GitHub runners)
            choco install llvm -y
            # Refresh PATH
            $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          }

          # Verify installation
          clang-tidy --version

      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 20
          cache: "npm"

      - run: npm ci --ignore-scripts

      # Run linting - the scripts handle platform differences
      - run: npm run lint

  # This goes away in Fall 2027: https://github.blog/changelog/2025-09-19-github-actions-macos-13-runner-image-is-closing-down/#notice-of-macos-x86_64-intel-architecture-deprecation
  prebuild-mac-x64:
    runs-on: macos-15-intel # Intel x64 runner
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 20
          cache: "npm"
      # We need to ignore scripts so the `install` script in package.json does
      # not run node-gyp-build
      - run: npm ci --ignore-scripts
      - run: npm run build:native
      - uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: prebuilds-macos-15-intel
          path: prebuilds/

  # macos-13 goes away November 2025: https://github.blog/changelog/2025-09-19-github-actions-macos-13-runner-image-is-closing-down
  prebuild-mac-arm64:
    runs-on: macos-14 # Apple Silicon ARM64 runner (default for macos-14)
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 20
          cache: "npm"
      # We need to ignore scripts so the `install` script in package.json does
      # not run node-gyp-build
      - run: npm ci --ignore-scripts
      - run: npm run build:native
      - uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: prebuilds-macos-14
          path: prebuilds/

  prebuild-win-x64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 20
          cache: "npm"
      # We need to ignore scripts so the `install` script in package.json does
      # not run node-gyp-build
      - run: npm ci --ignore-scripts
      - run: npm run build:native
      - uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: prebuilds-windows-latest
          path: prebuilds/

  prebuild-win-arm64:
    runs-on: windows-11-arm
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 20
          cache: "npm"
      # We need to ignore scripts so the `install` script in package.json does
      # not run node-gyp-build
      - run: npm ci --ignore-scripts
      - run: npm run build:native
      - uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: prebuilds-windows-11-arm
          path: prebuilds/

  prebuild-linux-glibc:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      # Build in Debian 11 Bullseye container for GLIBC 2.31 compatibility
      # This ensures compatibility with Ubuntu 20.04+ and modern Node.js Docker images
      # Note: npm ci is run inside the container by the build:linux-glibc script
      - run: TARGET_ARCH=${{ matrix.arch }} npm run build:linux-glibc
      - uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: prebuilds-linux-${{ matrix.arch }}-glibc
          path: prebuilds/

  prebuild-linux-musl:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: ubuntu-24.04
            platform: linux/amd64
          - arch: arm64
            runner: ubuntu-24.04-arm
            platform: linux/arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - run: |
          docker run --rm -v $(pwd):/tmp/project --entrypoint /bin/sh --platform ${{ matrix.platform }} node:20-alpine3.21 -c "\
          apk add build-base git python3 py3-setuptools util-linux-dev --update-cache && \
          cd /tmp/project && \
          npm ci --ignore-scripts && \
          npm run build:native"
      - uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: prebuilds-linux-${{ matrix.arch }}-musl
          path: prebuilds/

  test-mac-win:
    needs:
      - prebuild-mac-x64
      - prebuild-mac-arm64
      - prebuild-win-x64
      - prebuild-win-arm64
    strategy:
      fail-fast: false
      matrix:
        os: [macos-15-intel, macos-14, windows-latest, windows-11-arm]
        node-version: [20, 22, 24, 25]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: ./prebuilds
          merge-multiple: true
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
      - run: npm ci
      - run: npm run tests

  test-ubuntu:
    needs: [prebuild-linux-glibc]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        arch: [x64, arm64]
        node-version: [20, 22, 24, 25]
    runs-on: ${{ matrix.arch == 'arm64' && format('{0}-arm', matrix.os) || matrix.os }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - run: sudo apt-get update
      - run: sudo apt-get install -y libglib2.0-dev libblkid-dev uuid-dev
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ matrix.node-version }}
      - uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: ./prebuilds
          merge-multiple: true
      - run: npm ci
      - run: npm run tests

  test-alpine:
    needs: [prebuild-linux-musl]
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
        node-version: [20, 22, 24, 25]
        include:
          - arch: x64
            runner: ubuntu-24.04
            platform: linux/amd64
          - arch: arm64
            runner: ubuntu-24.04-arm
            platform: linux/arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: ./prebuilds
          merge-multiple: true
      - run: |
          docker run --rm -v $(pwd):/tmp/project --entrypoint /bin/sh --platform ${{ matrix.platform }} node:${{ matrix.node-version }}-alpine -c "\
          apk add util-linux-dev bash valgrind --update-cache && \
          cd /tmp/project && \
          npm ci && \
          npm run tests"

  publish:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-24.04
    needs:
      [
        test-mac-win,
        test-ubuntu,
        test-alpine,
        lint,
      ]
    permissions:
      id-token: write # Required for OIDC trusted publishing to npm
      contents: write # Required for release-it to create tags/commits
      packages: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          # Fetch full history for proper git operations
          fetch-depth: 0

      - uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: ./prebuilds
          merge-multiple: true

      # setup-node with registry-url is required for OIDC trusted publishing
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: lts/*
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - uses: photostructure/git-ssh-signing-action@a770c2ff3aea31d9df9f2974ac9d672f2bfe62f3 # v1.1.0
        with:
          ssh-signing-key: ${{ secrets.SSH_SIGNING_KEY }}
          git-user-name: ${{ secrets.GIT_USER_NAME }}
          git-user-email: ${{ secrets.GIT_USER_EMAIL }}

      - run: ls -laR ./prebuilds

      # Upgrade npm to support OIDC trusted publishing (requires npm >= 11.5.1)
      - run: npm install -g npm@latest

      - run: npm ci

      - run: npm run prepare-release

      - name: Release with release-it
        run: npm run release -- --ci ${{ github.event.inputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
